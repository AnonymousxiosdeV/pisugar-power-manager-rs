name: build-musl

on:
  workflow_call:

jobs:
  build-arm:
    runs-on: ubuntu-latest
    continue-on-error: true
    strategy:
      matrix:
        target:
          - arm-unknown-linux-musleabi
          - arm-unknown-linux-musleabihf
          - aarch64-unknown-linux-musl
    steps:
      # Checkout
      - name: Checkout
        uses: actions/checkout@v2

      - name: Fix cargo config
        run: sed -e "s/.*replace-with.*//g" -i .cargo/config.toml

      # Download web
      - name: Download web
        uses: actions/download-artifact@v3
        with:
          name: pisugar-web
          path: |
            electron/dist

      # Rust cache
      - uses: Swatinem/rust-cache@v1
      - uses: actions/cache@v3
        with:
          path: |
            /opt/arm-linux-musleabi-cross
            /opt/arm-linux-musleabihf-cross
            /opt/aarch64-linux-musl-cross
          key: ${{ runner.os }}-build-arm

      # Musl gcc
      - name: Download musl gcc
        env:
          target: ${{ matrix.target }}
        run: |
          if ! test -d /opt/arm-linux-musleabi-cross/bin; then
            wget https://more.musl.cc/$(uname -m)-linux-musl/arm-linux-musleabi-cross.tgz
            tar -xvf arm-linux-musleabi-cross.tgz
            mv arm-linux-musleabi-cross /opt/
          fi
          echo /opt/arm-linux-musleabi-cross/bin >> $GITHUB_PATH

          if ! test -d /opt/arm-linux-musleabihf-cross/bin; then
            wget https://more.musl.cc/$(uname -m)-linux-musl/arm-linux-musleabihf-cross.tgz
            tar -xvf arm-linux-musleabihf-cross.tgz
            mv arm-linux-musleabihf-cross /opt/
          fi
          echo /opt/arm-linux-musleabihf-cross/bin >> $GITHUB_PATH

          if ! test -d /opt/aarch64-linux-musl-cross/bin; then
            wget https://more.musl.cc/$(uname -m)-linux-musl/aarch64-linux-musl-cross.tgz
            tar -xvf aarch64-linux-musl-cross.tgz
            mv aarch64-linux-musl-cross /opt/
          fi
          echo /opt/aarch64-linux-musl-cross/bin >> $GITHUB_PATH

          arch=${target%%-*}
          runtime=${target##*-linux-}
          prefix=$arch-linux-$runtime

          TARGET=$(echo $target | tr '[a-z\-]' '[A-Z_]')
          echo "prefix=$prefix" >> $GITHUB_ENV
          echo "target=$target" >> $GITHUB_ENV
          echo "CARGO_TARGET_${TARGET}_LINKER=${prefix}-gcc" >> $GITHUB_ENV

      # Rust toolchain
      - name: Rust toolchain
        uses: actions-rs/toolchain@v1
        with:
          toolchain: stable
          target: ${{ matrix.target }}

      # Build
      - name: Rust build
        run: |
          find . -name '*.deb' | xargs rm -rf
          find . -name '*.rpm' | xargs rm -rf
          sudo apt update && sudo apt install -y rpm
          cargo install cargo-deb
          cargo install cargo-rpm
          cargo build --target ${target} --release
          for app in server poweroff programmer; do
            ${prefix}-strip -s target/${target}/release/pisugar-${app}
            cargo deb --no-build --no-strip --target $target --manifest-path=pisugar-${app}/Cargo.toml
            (cd pisugar-${app} && cargo rpm build --target ${target})
          done

      - name: Rename deb and rpm
        run: |
          for i in $(find . -name '*.deb'); do
            mv $i ${i%.deb}-musl.deb
          done
          for i in $(find . -name '*.rpm'); do
            mv $i ${i%.rpm}-musl.rpm
          done

      # Upload artifact
      - name: Upload artifact
        uses: actions/upload-artifact@v3
        with:
          name: musl-${{ matrix.target }}
          path: |
            target
            !target/release
            !target/**/.fingerprint
            !target/**/*.d
            !target/**/build
            !target/**/deps
            !target/**/examples
            !target/**/incremental
          if-no-files-found: warn
